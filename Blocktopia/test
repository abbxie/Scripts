-- ===============================
-- Rayfield Setup
-- ===============================
local Rayfield = loadstring(game:HttpGet('https://sirius.menu/rayfield'))()
local Window = Rayfield:CreateWindow({
    Name = "Block Highlighter & Puncher",
    LoadingTitle = "Block Tools",
    LoadingSubtitle = "by You",
    Theme = "Default"
})

local Tab = Window:CreateTab("Main", 4483362458)
local Section = Tab:CreateSection("Controls")

local Players = game:GetService("Players")
local player = Players.LocalPlayer
local character = player.Character or player.CharacterAdded:Wait()
local root = character:WaitForChild("HumanoidRootPart")

local worldBlocks = workspace:WaitForChild("WorldBlocks")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local punchRemote = ReplicatedStorage:WaitForChild("Events", 9e9):WaitForChild("PunchBlock", 9e9)

-- ðŸ”§ SETTINGS
local FRONT_ONLY = true
local UP_ONLY = false
local DOWN_ONLY = false
local DOT_THRESHOLD = 0.5
local Y_THRESHOLD = 2

-- Start with empty whitelist
local ALLOWED_BLOCKS = {}

-- Highlight object
local highlight = Instance.new("SelectionBox")
highlight.LineThickness = 0.05
highlight.SurfaceTransparency = 0.5
highlight.Color3 = Color3.fromRGB(255, 0, 0)
highlight.Parent = game.CoreGui

-- ===============================
-- Helper Functions
-- ===============================
local function isAllowedBlock(name)
    for _, allowed in ipairs(ALLOWED_BLOCKS) do
        if name == allowed then return true end
    end
    return false
end

local function passesDirectionFilters(block)
    local pos = block.Position
    local rootPos = root.Position
    if FRONT_ONLY then
        local lookVector = root.CFrame.LookVector
        local dirToBlock = (pos - rootPos).Unit
        local dot = lookVector:Dot(dirToBlock)
        if dot <= DOT_THRESHOLD then return false end
    end
    if UP_ONLY and not (pos.Y > rootPos.Y + Y_THRESHOLD) then return false end
    if DOWN_ONLY and not (pos.Y < rootPos.Y - Y_THRESHOLD) then return false end
    return true
end

local function getClosestBlock()
    local closest = nil
    local shortestDist = math.huge
    for _, block in ipairs(worldBlocks:GetChildren()) do
        for _, child in ipairs(block:GetChildren()) do
            if child:IsA("BasePart") and isAllowedBlock(child.Name) and passesDirectionFilters(child) then
                local dist = (child.Position - root.Position).Magnitude
                if dist < shortestDist then
                    shortestDist = dist
                    closest = child
                end
            end
        end
    end
    return closest
end

-- ===============================
-- Toggle control for Auto Punch & Highlight
-- ===============================
local running = false

local Toggle = Tab:CreateToggle({
    Name = "Auto Punch & Highlight",
    CurrentValue = false,
    Flag = "AutoPunchToggle",
    Callback = function(Value)
        running = Value
        if running then
            task.spawn(function()
                while running do
                    local closest = getClosestBlock()
                    if closest and closest.Parent and closest.Parent:IsDescendantOf(workspace) then
                        highlight.Adornee = closest

                        local children = worldBlocks:GetChildren()
                        local blockIndex = table.find(children, closest.Parent)
                        if blockIndex then
                            local args = { [1] = children[blockIndex] }
                            while running and children[blockIndex] and children[blockIndex]:IsDescendantOf(workspace) do
                                punchRemote:FireServer(unpack(args))
                                task.wait(0.05)
                            end
                        end
                    else
                        highlight.Adornee = nil
                        task.wait(0.1)
                    end
                end
                highlight.Adornee = nil
            end)
        else
            highlight.Adornee = nil
        end
    end
})

-- ===============================
-- Custom GUI for Whitelist
-- ===============================
local PlayerGui = player:WaitForChild("PlayerGui")

local screenGui = Instance.new("ScreenGui")
screenGui.Name = "WhitelistGUI"
screenGui.ResetOnSpawn = false
screenGui.Parent = PlayerGui

local frame = Instance.new("Frame")
frame.Size = UDim2.new(0, 300, 0, 50)
frame.Position = UDim2.new(0, 20, 0, 20)
frame.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
frame.BorderSizePixel = 0
frame.Parent = screenGui

local textBox = Instance.new("TextBox")
textBox.Size = UDim2.new(1, -10, 1, -10)
textBox.Position = UDim2.new(0, 5, 0, 5)
textBox.BackgroundColor3 = Color3.fromRGB(70, 70, 70)
textBox.TextColor3 = Color3.fromRGB(255, 255, 255)
textBox.PlaceholderText = "Enter blocks, e.g., Dirt, Stone"
textBox.ClearTextOnFocus = false
textBox.Text = ""
textBox.Parent = frame

-- Update whitelist when text changes
textBox.FocusLost:Connect(function(enterPressed)
    if enterPressed then
        ALLOWED_BLOCKS = {}
        for word in string.gmatch(textBox.Text, '([^,]+)') do
            local cleanWord = word:gsub("^%s*(.-)%s*$", "%1")
            if cleanWord ~= "" then
                -- Avoid duplicates
                if not table.find(ALLOWED_BLOCKS, cleanWord) then
                    table.insert(ALLOWED_BLOCKS, cleanWord)
                end
            end
        end
        print("Updated Whitelist:", unpack(ALLOWED_BLOCKS))
    end
end)
